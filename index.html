<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Looper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f9f9f9;
            color: #0f0f0f;
        }

        /* Top Banner Ad */
        .top-banner {
            width: 100%;
            height: 90px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
            border-bottom: 1px solid #ccc;
        }

        /* Main Container */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            gap: 20px;
        }

        /* Side Ads */
        .side-ad {
            width: 160px;
            background-color: #e0e0e0;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
            flex-shrink: 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Search Bar Container */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 40px;
            padding: 0 20px;
            height: 46px;
            transition: border-color 0.2s;
        }

        .search-box:focus-within {
            border-color: #065fd4;
        }

        .youtube-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .search-button {
            width: 46px;
            height: 46px;
            background-color: #065fd4;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .search-button:hover {
            background-color: #0456be;
        }

        .search-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* URL Display */
        .url-display {
            margin-bottom: 20px;
            font-size: 14px;
            color: #0f0f0f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .url-text {
            flex: 1;
            color: #065fd4;
            word-break: break-all;
        }

        .copy-button {
            padding: 8px 16px;
            background-color: #065fd4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .copy-button:hover {
            background-color: #0456be;
        }

        .copy-button.copied {
            background-color: #0f9d58;
        }

        /* Video Container */
        .video-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #d9d9d9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        /* Time Selection Controls */
        .time-controls {
            margin-top: 24px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .time-controls h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #0f0f0f;
        }

        .time-inputs {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-input-group label {
            font-size: 14px;
            color: #606060;
        }

        .time-input-group input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .apply-button {
            padding: 10px 24px;
            background-color: #065fd4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .apply-button:hover {
            background-color: #0456be;
        }

        .error-message {
            color: #cc0000;
            font-size: 14px;
            margin-top: 8px;
        }

        @media (max-width: 1200px) {
            .side-ad {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .top-banner {
                height: 50px;
                font-size: 12px;
            }

            .container {
                padding: 20px 10px;
            }

            .search-container {
                flex-direction: column;
            }

            .time-inputs {
                flex-direction: column;
                align-items: flex-start;
            }

            .url-display {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Top Banner Ad -->
    <div class="top-banner">Advertisement Banner</div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Side Ad -->
        <div class="side-ad">Ad Space</div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-box">
                    <svg class="youtube-icon" viewBox="0 0 24 24">
                        <path fill="#FF0000" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                    <input type="text" class="search-input" id="urlInput" placeholder="Paste video URL here">
                </div>
                <button class="search-button" id="searchButton">
                    <svg viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </button>
            </div>

            <!-- URL Display -->
            <div class="url-display">
                <div style="display: flex; align-items: center; gap: 4px;">
                    Looped URL: <span class="url-text" id="loopedUrl"></span>
                </div>
                <button class="copy-button" id="copyButton" style="display: none;">Copy Link</button>
            </div>

            <!-- Video Container -->
            <div class="video-container" id="videoContainer">
                Video Player
            </div>

            <!-- Time Selection Controls -->
            <div class="time-controls" id="timeControls">
                <h3>Select Loop Range</h3>
                <div class="time-inputs">
                    <div class="time-input-group">
                        <label>Start (seconds):</label>
                        <input type="number" id="startTime" min="0" value="0" step="1">
                    </div>
                    <div class="time-input-group">
                        <label>End (seconds):</label>
                        <input type="number" id="endTime" min="0" value="30" step="1">
                    </div>
                    <button class="apply-button" id="applyButton">Apply Loop</button>
                </div>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>

        <!-- Right Side Ad -->
        <div class="side-ad">Ad Space</div>
    </div>

    <script>
        let videoId = '';
        let player = null;
        let loopCheckInterval = null;
        let playerReady = false;
        let isApiReady = false; // AJOUT POUR SÉCURITÉ

        const urlInput = document.getElementById('urlInput');
        const searchButton = document.getElementById('searchButton');
        const videoContainer = document.getElementById('videoContainer');
        const loopedUrlSpan = document.getElementById('loopedUrl');
        const copyButton = document.getElementById('copyButton');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const applyButton = document.getElementById('applyButton');
        const errorMessage = document.getElementById('errorMessage');

        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
                /youtube\.com\/embed\/([^&\n?#]+)/,
                /youtube\.com\/v\/([^&\n?#]+)/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        function updateSearchButtonIcon(status) {
            const svg = searchButton.querySelector('svg');
            if (status === 'error') {
                svg.innerHTML = '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>';
            } else if (status === 'success') {
                svg.innerHTML = '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>';
            } else {
                svg.innerHTML = '<path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>';
            }
        }

        function onYouTubeIframeAPIReady() {
            isApiReady = true; // SÉCURITÉ ACTIVÉE
            
            // Check if we have URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const videoParam = urlParams.get('v');
            const startParam = urlParams.get('start');
            const endParam = urlParams.get('end');
            
            if (videoParam) {
                urlInput.value = `https://www.youtube.com/watch?v=${videoParam}`;
                videoId = videoParam;
                startTimeInput.value = parseInt(startParam) || 0;
                endTimeInput.value = parseInt(endParam) || 30;
                loadVideo();
            }
        }

        function loadVideo() {
            // VERIFICATION : Si l'API n'est pas prête, on attend
            if (!isApiReady) {
                console.log("YouTube API not yet ready");
                return;
            }

            const url = urlInput.value.trim();
            if (!url) {
                updateSearchButtonIcon('error');
                return;
            }

            videoId = extractVideoId(url);
            if (!videoId) {
                updateSearchButtonIcon('error');
                loopedUrlSpan.textContent = '';
                copyButton.style.display = 'none';
                return;
            }

            updateSearchButtonIcon('success');
            
            const startTime = parseInt(startTimeInput.value) || 0;
            const endTime = parseInt(endTimeInput.value) || 30;
            
            updateLoopedUrl();
            
            if (player) {
                try { player.destroy(); } catch(e) {}
            }

            videoContainer.innerHTML = '<div id="ytPlayer"></div>';
            
            player = new YT.Player('ytPlayer', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'start': startTime,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'origin': window.location.origin // AIDE POUR ERREUR 153
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError // AJOUT GESTION ERREUR
                }
            });
        }

        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
            if (event.data === 150 || event.data === 101) {
                errorMessage.textContent = "Error: Video owner does not allow embedding.";
            } else if (event.data === 153) {
                 errorMessage.textContent = "Error 153: Permisssion issue. If opening via file://, please use a local server.";
            }
        }

        function onPlayerReady(event) {
            playerReady = true;
            
            // Get video duration and set as max for end time
            const duration = Math.floor(player.getDuration());
            if (duration > 0) {
                endTimeInput.max = duration;
                // Auto-set end time to video duration if still at default
                if (endTimeInput.value == 30 || parseInt(endTimeInput.value) > duration) {
                    endTimeInput.value = duration;
                }
            }
            
            startLoopCheck();
        }

        function onPlayerStateChange(event) {
            // When video ends, loop back to start
            if (event.data === YT.PlayerState.ENDED) {
                const startTime = parseInt(startTimeInput.value) || 0;
                player.seekTo(startTime);
                player.playVideo();
            }
        }

        function startLoopCheck() {
            if (loopCheckInterval) {
                clearInterval(loopCheckInterval);
            }
            
            loopCheckInterval = setInterval(() => {
                // Vérification de sécurité renforcée
                if (player && playerReady && typeof player.getCurrentTime === 'function') {
                    const currentTime = player.getCurrentTime();
                    const endTime = parseInt(endTimeInput.value) || 30;
                    const startTime = parseInt(startTimeInput.value) || 0;
                    
                    if (currentTime >= endTime) {
                        player.seekTo(startTime);
                    }
                }
            }, 200);
        }

        function updateLoopedUrl() {
            // MODIFICATION: Générer un lien Embed YouTube direct
            const startTime = parseInt(startTimeInput.value) || 0;
            const endTime = parseInt(endTimeInput.value) || 30;
            
            if (videoId) {
                // Création du lien embed avec playlist pour permettre le bouclage natif
                const embedUrl = `https://www.youtube.com/embed/${videoId}?start=${startTime}&end=${endTime}&loop=1&playlist=${videoId}&autoplay=1`;
                loopedUrlSpan.textContent = embedUrl;
                copyButton.style.display = 'block';
            }
        }

        function applyLoop() {
            const startTime = parseInt(startTimeInput.value) || 0;
            const endTime = parseInt(endTimeInput.value) || 30;
            
            if (startTime >= endTime) {
                errorMessage.textContent = 'End time must be greater than start time';
                return;
            }
            
            if (startTime < 0 || endTime < 0) {
                errorMessage.textContent = 'Times must be positive numbers';
                return;
            }
            
            errorMessage.textContent = '';
            
            updateLoopedUrl();
            
            if (player && playerReady) {
                player.seekTo(startTime);
                player.playVideo();
                startLoopCheck();
            }
        }

        function copyToClipboard() {
            const url = loopedUrlSpan.textContent;
            if (!url) return;
            
            // Méthode de copie plus robuste
            const textArea = document.createElement("textarea");
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                const originalText = copyButton.textContent;
                copyButton.textContent = '✓ Copied!';
                copyButton.classList.add('copied');
                
                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy', err);
            }
            document.body.removeChild(textArea);
        }

        searchButton.addEventListener('click', loadVideo);
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadVideo();
            }
        });
        applyButton.addEventListener('click', applyLoop);
        copyButton.addEventListener('click', copyToClipboard);
    </script>
</body>
</html>